<?php
namespace App\Http\Middleware;use Closure;use Illuminate\Http\Request;use Symfony\Component\HttpFoundation\Response;class SanitizeInput{protected array $except=['password','password_confirmation','current_password',];public function handle(Request $request,Closure $next):Response{$input=$request->all();$sanitized=$this->sanitizeArray($input);$request->merge($sanitized);return $next($request);}protected function sanitizeArray(array $data):array{$result=[];foreach($data as $key=>$value){if(in_array($key,$this->except,true)){$result[$key]=$value;continue;}if(is_array($value)){$result[$key]=$this->sanitizeArray($value);}elseif(is_string($value)){$result[$key]=$this->sanitizeString($value);}else{$result[$key]=$value;}}return $result;}protected function sanitizeString(string $value):string{$value=$this->preventXss($value);$value=$this->preventPathTraversal($value);$value=$this->preventSqlInjection($value);return $value;}protected function preventXss(string $value):string{$value=preg_replace('/<script\b[^>]*>(.*?)<\/script>/is','',$value);$value=preg_replace('/on\w+\s*=\s*["\'][^"\']*["\']/i','',$value);$value=preg_replace('/javascript\s*:/i','',$value);$value=preg_replace('/vbscript\s*:/i','',$value);$value=preg_replace('/data\s*:[^,]*base64/i','',$value);return $value;}protected function preventPathTraversal(string $value):string{$value=str_replace(['../','..\\','%2e%2e%2f','%2e%2e/'],'',$value);$value=preg_replace('/\.{2,}/','.',$value);return $value;}protected function preventSqlInjection(string $value):string{$patterns=['/\bUNION\s+SELECT\b/i','/\bSELECT\s+.*\s+FROM\b/i','/\bINSERT\s+INTO\b/i','/\bDELETE\s+FROM\b/i','/\bDROP\s+TABLE\b/i','/\bDROP\s+DATABASE\b/i','/\bALTER\s+TABLE\b/i','/\bEXEC\s*\(/i','/\bEXECUTE\s*\(/i','/;\s*--/','/\b(OR|AND)\s+[\'\"]?\d+[\'\"]?\s*=\s*[\'\"]?\d+[\'\"]?\b/i',];foreach($patterns as $pattern){if(preg_match($pattern,$value)){$value=preg_replace($pattern,'',$value);}}return $value;}}