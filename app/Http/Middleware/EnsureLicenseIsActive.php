<?php
namespace App\Http\Middleware;use App\Services\LicenseService;use Closure;use Illuminate\Http\Request;class EnsureLicenseIsActive{protected LicenseService $licenseService;public function __construct(LicenseService $licenseService){$this->licenseService=$licenseService;}public function handle(Request $request,Closure $next){if(!session('license_authenticated')){$license=$this->licenseService->loadLocalLicense();if(!$license||empty($license['license_key'])){return redirect()->route('license.activate.form')->withErrors(['msg'=>'Lisensi tidak ditemukan. Silakan aktivasi terlebih dahulu.']);}return redirect()->route('login')->withErrors(['msg'=>'Silakan login terlebih dahulu.']);}$license=$this->licenseService->loadLocalLicense();if(!$license||($license['status']??'inactive')!=='active'){session()->forget('license_authenticated');session()->forget('license_user_email');return redirect()->route('license.activate.form')->withErrors(['msg'=>'Lisensi tidak aktif. Silakan aktivasi ulang.']);}return $next($request);}}